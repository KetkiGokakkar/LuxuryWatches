{% extends 'base.html' %}
{% load static %}
{% load store_tags %}
{% load humanize %}

{% block title %}Luxury Watch Collection — LuxWatch{% endblock %}

{% block content %}
<section class="page-header">
    <div class="container">
        <h1>Our <em>Collection</em></h1>
        <p>{{ watches|length }} exceptional timepieces</p>
    </div>
</section>

<section class="section">
    <div class="container">
        <div class="catalog-layout">
            <!-- Sidebar Filters -->
            <aside class="filter-sidebar">
                <div class="filter-header">
                    <h3><i class="fas fa-sliders-h"></i> Filters</h3>
                    <a href="{% url 'store:watch_list' %}" class="filter-clear">Clear All</a>
                </div>

                <form method="GET" action="{% url 'store:watch_list' %}" id="filterForm">
                    <div class="filter-group">
                        <h4>Brand</h4>
                        {% for brand in brands %}
                        <label class="filter-option">
                            <input type="radio" name="brand" value="{{ brand.slug }}" {% if current_brand == brand.slug %}checked{% endif %} onchange="this.form.submit()">
                            <span>{{ brand.name }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <div class="filter-group">
                        <h4>Category</h4>
                        {% for cat in categories %}
                        <label class="filter-option">
                            <input type="radio" name="category" value="{{ cat.slug }}" {% if current_category == cat.slug %}checked{% endif %} onchange="this.form.submit()">
                            <span>{{ cat.name }}</span>
                        </label>
                        {% endfor %}
                    </div>

                    <div class="filter-group">
                        <h4>Price Range</h4>
                        <div class="price-inputs">
                            <input type="number" name="min_price" placeholder="Min ₹" value="{{ min_price }}" class="form-input">
                            <span>—</span>
                            <input type="number" name="max_price" placeholder="Max ₹" value="{{ max_price }}" class="form-input">
                        </div>
                        <button type="submit" class="btn btn-sm btn-gold" style="margin-top:10px;width:100%">Apply</button>
                    </div>
                </form>
            </aside>

            <!-- Watch Grid -->
            <div class="catalog-main">
                <div class="catalog-toolbar">
                    <span class="result-count">{{ watches|length }} watches found</span>
                    <div class="sort-select">
                        <label>Sort by:</label>
                        <select onchange="window.location.href=updateUrlParam('sort', this.value)">
                            <option value="newest" {% if current_sort == 'newest' %}selected{% endif %}>Newest</option>
                            <option value="price_low" {% if current_sort == 'price_low' %}selected{% endif %}>Price: Low to High</option>
                            <option value="price_high" {% if current_sort == 'price_high' %}selected{% endif %}>Price: High to Low</option>
                            <option value="name" {% if current_sort == 'name' %}selected{% endif %}>Name A-Z</option>
                            <option value="rating" {% if current_sort == 'rating' %}selected{% endif %}>Top Rated</option>
                        </select>
                    </div>
                </div>

                {% if watches %}
                <div class="watch-grid">
                    {% for watch in watches %}
                    <div class="watch-card">
                        <a href="{{ watch.get_absolute_url }}">
                            <div class="watch-card-image">
                                {% if watch.image %}
                                <img src="{{ watch.image.url }}" alt="{{ watch.name }}" loading="lazy">
                                {% else %}
                                <div class="watch-placeholder"><i class="fas fa-clock"></i></div>
                                {% endif %}
                                {% if watch.discount_percentage %}
                                <span class="badge badge-sale">-{{ watch.discount_percentage }}%</span>
                                {% endif %}
                                {% if watch.is_new_arrival %}
                                <span class="badge badge-new">New</span>
                                {% endif %}
                                {% if watch.is_bestseller %}
                                <span class="badge badge-best">Bestseller</span>
                                {% endif %}
                            </div>
                        </a>
                        <div class="watch-card-info">
                            <span class="watch-brand">{{ watch.brand.name }}</span>
                            <a href="{{ watch.get_absolute_url }}"><h3 class="watch-name">{{ watch.name }}</h3></a>
                            {% if watch.avg_rating > 0 %}
                            <div class="watch-rating">
                                {% for i in watch.avg_rating|star_range %}<i class="fas fa-star"></i>{% endfor %}
                                {% for i in watch.avg_rating|empty_star_range %}<i class="far fa-star"></i>{% endfor %}
                                <span>({{ watch.review_count }})</span>
                            </div>
                            {% endif %}
                            <div class="watch-price">
                                <span class="price-current">₹{{ watch.price|floatformat:0|intcomma }}</span>
                                {% if watch.original_price %}
                                <span class="price-original">₹{{ watch.original_price|floatformat:0|intcomma }}</span>
                                {% endif %}
                            </div>
                            <form method="POST" action="{% url 'cart:add_to_cart' watch.id %}" class="add-to-cart-form">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-add-cart"><i class="fas fa-shopping-bag"></i> Add to Cart</button>
                            </form>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-clock"></i>
                    <h3>No watches found</h3>
                    <p>Try adjusting your filters or browse our full collection.</p>
                    <a href="{% url 'store:watch_list' %}" class="btn btn-gold">View All</a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<script>
function updateUrlParam(key, value) {
    const url = new URL(window.location);
    url.searchParams.set(key, value);
    return url.toString();
}
</script>
{% endblock %}
